<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lexicon ‚Äî MTG Pocket Companion</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
           background:#0f172a; color:#e5e7eb; }
    header { padding:16px 18px; font-weight:700; font-size:18px; background:#111827; border-bottom:1px solid #1f2937;
             display:flex; justify-content:space-between; align-items:center; }
    main { max-width:960px; margin:0 auto; padding:16px; }
    .bar { display:flex; gap:8px; margin-bottom:12px; }
    input[type="text"] { flex:1; padding:12px 14px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #334155; background:#111827; color:#e5e7eb; cursor:pointer; }
    button:hover { background:#0b1220; }
    #log { height:480px; overflow:auto; padding:14px; border:1px solid #1f2937; border-radius:12px; background:#0b1220; }
    .msg { margin:12px 0; line-height:1.5; }
    .msg h1,.msg h2,.msg h3 { margin:14px 0 8px; line-height:1.2; }
    .msg h3 { font-size:1.05rem; color:#93c5fd; }
    .msg ul { margin:6px 0 10px 1.25em; }
    .msg li { margin:2px 0; }
    .msg strong { color:#e0e7ff; }
    .tip { margin-top:10px; font-size:12px; color:#94a3b8; }
    #preview { position:absolute; display:none; z-index:50; border:1px solid #1f2937; border-radius:10px; background:#0b1220; padding:6px; }
    #preview img { width:320px; max-width:80vw; border-radius:8px; display:block; }
    .card-inline { color:#93c5fd; cursor:pointer; border-bottom:1px dotted #334155; }
    .actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .hidden { display:none; }
    /* modal */
    .modal { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); }
    .modal > div { width:min(560px, 92vw); background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:16px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label { font-size:14px; color:#cbd5e1; display:block; margin-bottom:4px; }
    input[type="number"], select { width:100%; padding:10px; border-radius:10px; border:1px solid #334155; background:#0a1120; color:#e5e7eb; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header>
    <div>Lexicon ‚Äî MTG Pocket Companion</div>
    <div class="actions">
      <button id="settingsBtn" type="button">‚öôÔ∏è Settings</button>
      <button id="feedbackBtn" type="button">üí¨ Feedback</button>
    </div>
  </header>
  <main>
    <form id="chatForm" class="bar">
      <input id="prompt" type="text" placeholder="Talk to Lexicon‚Ä¶ (e.g., Build a UW Gandalf control shell with sections)"
             autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false" />
      <button id="speakBtn" type="button">üéôÔ∏è Speak</button>
      <button type="submit">Send</button>
      <button id="clearBtn" type="button">Clear</button>
    </form>

    <div id="log"></div>
    <div class="actions">
      <button id="checkBtn" class="hidden" type="button">üîç Check Legality & Budget</button>
    </div>
    <div class="tip">Tip: any <b>card name</b> becomes hover-previewable via Scryfall.</div>
    <div id="preview"><img alt="card preview"></div>
  </main>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal">
    <div>
      <h3 style="margin:0 0 10px;">Settings</h3>
      <div class="grid">
        <div>
          <label for="formatSel">Format</label>
          <select id="formatSel">
            <option value="commander">Commander</option>
            <option value="modern">Modern</option>
            <option value="pioneer">Pioneer</option>
            <option value="standard">Standard</option>
          </select>
        </div>
        <div>
          <label for="budgetUsd">Budget cap (USD)</label>
          <input id="budgetUsd" type="number" min="0" step="1" placeholder="0 = no cap" />
        </div>
        <div>
          <label for="priceSource">Price source</label>
          <select id="priceSource">
            <option value="usd">USD (non-foil)</option>
            <option value="usd_foil">USD Foil</option>
            <option value="usd_etched">USD Etched</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="closeSettings" type="button">Close</button>
        <button id="saveSettings" type="button">Save</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <!-- === LEXICON CHAT WIDGET (Copy-Paste Only) === -->
<div id="lex-chat" style="max-width:700px;margin:20px auto;font-family:sans-serif">
  <h3>Lexicon Chat</h3>
  <div id="lex-log" style="height:260px;overflow:auto;border:1px solid #ddd;padding:10px;border-radius:8px;white-space:pre-wrap;background:#fff"></div>
  <div style="margin-top:8px;display:flex;gap:8px">
    <input id="lex-msg" placeholder="Type a message‚Ä¶" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:6px" />
    <button id="lex-send" type="button" style="padding:8px 14px;border:0;border-radius:6px;background:#4f46e5;color:white">Send</button>
  </div>
  <div id="lex-status" style="margin-top:6px;color:#666;font-size:12px"></div>
</div>

<script>
(() => {
  // where your chat messages go
  const API = "https://lexicon-proxy-holy-band-319a.biznuslobbstr.workers.dev";
  const log = document.getElementById("lex-log");
  const msg = document.getElementById("lex-msg");
  const send = document.getElementById("lex-send");
  const statusEl = document.getElementById("lex-status");
  const sessionId = localStorage.getItem("lex_session") || (crypto.randomUUID?.() || String(Date.now()));
  localStorage.setItem("lex_session", sessionId);

  function append(who, text) {
    const time = new Date().toLocaleTimeString();
    log.textContent += `[${time}] ${who}: ${text}\n\n`;
    log.scrollTop = log.scrollHeight;
  }
  function setStatus(t){ statusEl.textContent = t; }

  // check if the backend works
  fetch(`${API}/health`).then(r=>r.json()).then(h=>{
    setStatus(h.ok ? "Backend ready." : "Backend issue.");
  }).catch(()=>setStatus("Cannot reach backend."));

  async function sendChat(text) {
    append("You", text);
    setStatus("Sending‚Ä¶");
    send.disabled = true;

    try {
      const res = await fetch(`${API}/chat`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          sessionId,
          messages: [{ role: "user", content: text }]
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        append("System", `Error ${res.status}: ${data.error || data.text || "Unknown"}`);
      } else {
        append("Lexicon", data.message || "(no content)");
      }
    } catch (e) {
      append("System", "Network error: " + e);
    } finally {
      setStatus("");
      send.disabled = false;
    }
  }

  // when you click Send
  send.addEventListener("click", () => {
    const text = msg.value.trim();
    if (!text) return;
    msg.value = "";
    sendChat(text);
  });

  // also send when you press Enter
  msg.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      send.click();
    }
  });
})();
</script>
<!-- === END CHAT WIDGET === -->

</body>
</html>
